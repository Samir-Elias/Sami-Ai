// ============================================
// ‚úÖ VALIDATION MIDDLEWARE
// ============================================

import { body, query, param, validationResult } from 'express-validator';
import { log } from '../config/logger.js';

/**
 * üîß Middleware para manejar errores de validaci√≥n
 */
export const handleValidationErrors = (req, res, next) => {
  const errors = validationResult(req);
  
  if (!errors.isEmpty()) {
    const formattedErrors = errors.array().map(error => ({
      field: error.path || error.param,
      message: error.msg,
      value: error.value,
      location: error.location
    }));

    log.debug('Validation errors', {
      errors: formattedErrors,
      url: req.originalUrl,
      method: req.method
    });

    return res.status(400).json({
      success: false,
      message: 'Datos de entrada inv√°lidos',
      errors: formattedErrors,
      code: 'VALIDATION_ERROR'
    });
  }
  
  next();
};

// ============================================
// üîê VALIDACIONES DE AUTENTICACI√ìN
// ============================================

export const validateRegister = [
  body('email')
    .isEmail()
    .normalizeEmail()
    .withMessage('Email inv√°lido'),
  
  body('password')
    .isLength({ min: 8 })
    .withMessage('La contrase√±a debe tener al menos 8 caracteres')
    .matches(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/)
    .withMessage('La contrase√±a debe contener al menos una min√∫scula, una may√∫scula y un n√∫mero'),
  
  body('username')
    .optional()
    .isLength({ min: 3, max: 30 })
    .withMessage('El username debe tener entre 3 y 30 caracteres')
    .matches(/^[a-zA-Z0-9_-]+$/)
    .withMessage('El username solo puede contener letras, n√∫meros, guiones y guiones bajos'),
  
  body('name')
    .optional()
    .isLength({ min: 2, max: 100 })
    .withMessage('El nombre debe tener entre 2 y 100 caracteres')
    .trim(),
  
  handleValidationErrors
];

export const validateLogin = [
  body('email')
    .isEmail()
    .normalizeEmail()
    .withMessage('Email inv√°lido'),
  
  body('password')
    .notEmpty()
    .withMessage('Contrase√±a requerida'),
  
  handleValidationErrors
];

export const validateRefreshToken = [
  body('refreshToken')
    .notEmpty()
    .withMessage('Refresh token requerido'),
  
  handleValidationErrors
];

export const validateChangePassword = [
  body('currentPassword')
    .notEmpty()
    .withMessage('Contrase√±a actual requerida'),
  
  body('newPassword')
    .isLength({ min: 8 })
    .withMessage('La nueva contrase√±a debe tener al menos 8 caracteres')
    .matches(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/)
    .withMessage('La nueva contrase√±a debe contener al menos una min√∫scula, una may√∫scula y un n√∫mero'),
  
  body('confirmPassword')
    .custom((value, { req }) => {
      if (value !== req.body.newPassword) {
        throw new Error('Las contrase√±as no coinciden');
      }
      return true;
    }),
  
  handleValidationErrors
];

export const validateForgotPassword = [
  body('email')
    .isEmail()
    .normalizeEmail()
    .withMessage('Email inv√°lido'),
  
  handleValidationErrors
];

export const validateResetPassword = [
  body('token')
    .notEmpty()
    .withMessage('Token de reset requerido'),
  
  body('password')
    .isLength({ min: 8 })
    .withMessage('La contrase√±a debe tener al menos 8 caracteres')
    .matches(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/)
    .withMessage('La contrase√±a debe contener al menos una min√∫scula, una may√∫scula y un n√∫mero'),
  
  handleValidationErrors
];

// ============================================
// üë§ VALIDACIONES DE USUARIO
// ============================================

export const validateUpdateProfile = [
  body('username')
    .optional()
    .isLength({ min: 3, max: 30 })
    .withMessage('El username debe tener entre 3 y 30 caracteres')
    .matches(/^[a-zA-Z0-9_-]+$/)
    .withMessage('El username solo puede contener letras, n√∫meros, guiones y guiones bajos'),
  
  body('name')
    .optional()
    .isLength({ min: 2, max: 100 })
    .withMessage('El nombre debe tener entre 2 y 100 caracteres')
    .trim(),
  
  body('preferences')
    .optional()
    .isObject()
    .withMessage('Las preferencias deben ser un objeto'),
  
  body('preferences.theme')
    .optional()
    .isIn(['light', 'dark'])
    .withMessage('El tema debe ser light o dark'),
  
  body('preferences.language')
    .optional()
    .isIn(['es', 'en'])
    .withMessage('El idioma debe ser es o en'),
  
  body('settings')
    .optional()
    .isObject()
    .withMessage('La configuraci√≥n debe ser un objeto'),
  
  handleValidationErrors
];

// ============================================
// üí¨ VALIDACIONES DE CONVERSACIONES
// ============================================

export const validateCreateConversation = [
  body('title')
    .notEmpty()
    .withMessage('T√≠tulo requerido')
    .isLength({ min: 1, max: 200 })
    .withMessage('El t√≠tulo debe tener entre 1 y 200 caracteres')
    .trim(),
  
  body('projectId')
    .optional()
    .isString()
    .withMessage('ID de proyecto inv√°lido'),
  
  body('aiProvider')
    .optional()
    .isIn(['gemini', 'groq', 'huggingface', 'ollama'])
    .withMessage('Proveedor de IA inv√°lido'),
  
  body('aiModel')
    .optional()
    .isString()
    .withMessage('Modelo de IA inv√°lido'),
  
  handleValidationErrors
];

export const validateUpdateConversation = [
  body('title')
    .optional()
    .isLength({ min: 1, max: 200 })
    .withMessage('El t√≠tulo debe tener entre 1 y 200 caracteres')
    .trim(),
  
  body('isPinned')
    .optional()
    .isBoolean()
    .withMessage('isPinned debe ser boolean'),
  
  body('isArchived')
    .optional()
    .isBoolean()
    .withMessage('isArchived debe ser boolean'),
  
  handleValidationErrors
];

// ============================================
// üì® VALIDACIONES DE MENSAJES
// ============================================

export const validateCreateMessage = [
  body('conversationId')
    .notEmpty()
    .withMessage('ID de conversaci√≥n requerido')
    .isString()
    .withMessage('ID de conversaci√≥n inv√°lido'),
  
  body('content')
    .notEmpty()
    .withMessage('Contenido del mensaje requerido')
    .isLength({ min: 1, max: 10000 })
    .withMessage('El contenido debe tener entre 1 y 10000 caracteres')
    .trim(),
  
  body('aiProvider')
    .optional()
    .isIn(['gemini', 'groq', 'huggingface', 'ollama'])
    .withMessage('Proveedor de IA inv√°lido'),
  
  body('aiModel')
    .optional()
    .isString()
    .withMessage('Modelo de IA inv√°lido'),
  
  body('attachments')
    .optional()
    .isArray()
    .withMessage('Los adjuntos deben ser un array'),
  
  handleValidationErrors
];

export const validateUpdateMessage = [
  body('content')
    .optional()
    .isLength({ min: 1, max: 10000 })
    .withMessage('El contenido debe tener entre 1 y 10000 caracteres')
    .trim(),
  
  body('rating')
    .optional()
    .isInt({ min: 1, max: 5 })
    .withMessage('La calificaci√≥n debe ser entre 1 y 5'),
  
  body('feedback')
    .optional()
    .isLength({ max: 1000 })
    .withMessage('El feedback debe tener m√°ximo 1000 caracteres')
    .trim(),
  
  handleValidationErrors
];

// ============================================
// üìÅ VALIDACIONES DE PROYECTOS
// ============================================

export const validateCreateProject = [
  body('name')
    .notEmpty()
    .withMessage('Nombre del proyecto requerido')
    .isLength({ min: 1, max: 100 })
    .withMessage('El nombre debe tener entre 1 y 100 caracteres')
    .trim(),
  
  body('description')
    .optional()
    .isLength({ max: 500 })
    .withMessage('La descripci√≥n debe tener m√°ximo 500 caracteres')
    .trim(),
  
  handleValidationErrors
];

export const validateUpdateProject = [
  body('name')
    .optional()
    .isLength({ min: 1, max: 100 })
    .withMessage('El nombre debe tener entre 1 y 100 caracteres')
    .trim(),
  
  body('description')
    .optional()
    .isLength({ max: 500 })
    .withMessage('La descripci√≥n debe tener m√°ximo 500 caracteres')
    .trim(),
  
  body('isArchived')
    .optional()
    .isBoolean()
    .withMessage('isArchived debe ser boolean'),
  
  handleValidationErrors
];

// ============================================
// üîë VALIDACIONES DE API KEYS
// ============================================

export const validateCreateApiKey = [
  body('provider')
    .notEmpty()
    .withMessage('Proveedor requerido')
    .isIn(['gemini', 'groq', 'huggingface', 'openai'])
    .withMessage('Proveedor inv√°lido'),
  
  body('apiKey')
    .notEmpty()
    .withMessage('API key requerida')
    .isLength({ min: 10 })
    .withMessage('API key muy corta'),
  
  body('name')
    .optional()
    .isLength({ min: 1, max: 100 })
    .withMessage('El nombre debe tener entre 1 y 100 caracteres')
    .trim(),
  
  handleValidationErrors
];

export const validateUpdateApiKey = [
  body('name')
    .optional()
    .isLength({ min: 1, max: 100 })
    .withMessage('El nombre debe tener entre 1 y 100 caracteres')
    .trim(),
  
  body('isActive')
    .optional()
    .isBoolean()
    .withMessage('isActive debe ser boolean'),
  
  body('isDefault')
    .optional()
    .isBoolean()
    .withMessage('isDefault debe ser boolean'),
  
  handleValidationErrors
];

// ============================================
// ü§ñ VALIDACIONES DE IA
// ============================================

export const validateAiChat = [
  body('messages')
    .isArray({ min: 1 })
    .withMessage('Se requiere al menos un mensaje'),
  
  body('messages.*.role')
    .isIn(['user', 'assistant', 'system'])
    .withMessage('Rol de mensaje inv√°lido'),
  
  body('messages.*.content')
    .notEmpty()
    .withMessage('Contenido del mensaje requerido')
    .isLength({ max: 10000 })
    .withMessage('Contenido muy largo'),
  
  body('provider')
    .optional()
    .isIn(['gemini', 'groq', 'huggingface', 'ollama'])
    .withMessage('Proveedor de IA inv√°lido'),
  
  body('model')
    .optional()
    .isString()
    .withMessage('Modelo inv√°lido'),
  
  body('stream')
    .optional()
    .isBoolean()
    .withMessage('Stream debe ser boolean'),
  
  handleValidationErrors
];

// ============================================
// üìä VALIDACIONES DE QUERY PARAMETERS
// ============================================

export const validatePagination = [
  query('page')
    .optional()
    .isInt({ min: 1 })
    .withMessage('La p√°gina debe ser un n√∫mero entero mayor a 0')
    .toInt(),
  
  query('limit')
    .optional()
    .isInt({ min: 1, max: 100 })
    .withMessage('El l√≠mite debe ser entre 1 y 100')
    .toInt(),
  
  query('sort')
    .optional()
    .isString()
    .withMessage('Campo de ordenamiento inv√°lido'),
  
  query('order')
    .optional()
    .isIn(['asc', 'desc'])
    .withMessage('El orden debe ser asc o desc'),
  
  handleValidationErrors
];

export const validateSearch = [
  query('q')
    .optional()
    .isString()
    .isLength({ min: 1, max: 100 })
    .withMessage('La b√∫squeda debe tener entre 1 y 100 caracteres')
    .trim(),
  
  query('category')
    .optional()
    .isString()
    .withMessage('Categor√≠a inv√°lida'),
  
  query('language')
    .optional()
    .isString()
    .withMessage('Idioma inv√°lido'),
  
  handleValidationErrors
];

// ============================================
// üîß VALIDACIONES DE PAR√ÅMETROS
// ============================================

export const validateId = [
  param('id')
    .notEmpty()
    .withMessage('ID requerido')
    .isString()
    .withMessage('ID inv√°lido'),
  
  handleValidationErrors
];

export const validateUserId = [
  param('userId')
    .notEmpty()
    .withMessage('ID de usuario requerido')
    .isString()
    .withMessage('ID de usuario inv√°lido'),
  
  handleValidationErrors
];

export const validateConversationId = [
  param('conversationId')
    .notEmpty()
    .withMessage('ID de conversaci√≥n requerido')
    .isString()
    .withMessage('ID de conversaci√≥n inv√°lido'),
  
  handleValidationErrors
];

export const validateProjectId = [
  param('projectId')
    .notEmpty()
    .withMessage('ID de proyecto requerido')
    .isString()
    .withMessage('ID de proyecto inv√°lido'),
  
  handleValidationErrors
];

// ============================================
// üß™ FUNCIONES AUXILIARES Y TESTING
// ============================================

/**
 * üîß Crear validador personalizado
 */
export const createCustomValidator = (validationRules) => {
  return [...validationRules, handleValidationErrors];
};

/**
 * üîç Validador condicional
 */
export const conditionalValidation = (condition, validator) => {
  return (req, res, next) => {
    if (condition(req)) {
      return validator(req, res, next);
    }
    next();
  };
};

/**
 * üìù Validar contenido de archivo
 */
export const validateFileContent = [
  body('filename')
    .notEmpty()
    .withMessage('Nombre de archivo requerido')
    .matches(/\.(js|jsx|ts|tsx|py|java|cpp|c|cs|php|rb|go|rs|swift|kt|dart|html|css|json|md|txt)$/i)
    .withMessage('Tipo de archivo no soportado'),
  
  body('content')
    .notEmpty()
    .withMessage('Contenido del archivo requerido')
    .isLength({ max: 1048576 }) // 1MB
    .withMessage('Archivo muy grande (m√°ximo 1MB)'),
  
  handleValidationErrors
];

/**
 * üìä Validar datos de analytics
 */
export const validateAnalyticsEvent = [
  body('event')
    .notEmpty()
    .withMessage('Evento requerido')
    .isString()
    .withMessage('Evento inv√°lido'),
  
  body('category')
    .notEmpty()
    .withMessage('Categor√≠a requerida')
    .isString()
    .withMessage('Categor√≠a inv√°lida'),
  
  body('action')
    .notEmpty()
    .withMessage('Acci√≥n requerida')
    .isString()
    .withMessage('Acci√≥n inv√°lida'),
  
  body('properties')
    .optional()
    .isObject()
    .withMessage('Las propiedades deben ser un objeto'),
  
  handleValidationErrors
];

/**
 * üß™ Helper para testing
 */
export const mockValidationSuccess = (req, res, next) => {
  next();
};

export const mockValidationError = (errors = []) => (req, res, next) => {
  return res.status(400).json({
    success: false,
    message: 'Validation error (mock)',
    errors: errors,
    code: 'VALIDATION_ERROR'
  });
};

export default {
  handleValidationErrors,
  
  // Auth validations
  validateRegister,
  validateLogin,
  validateRefreshToken,
  validateChangePassword,
  validateForgotPassword,
  validateResetPassword,
  
  // User validations
  validateUpdateProfile,
  
  // Conversation validations
  validateCreateConversation,
  validateUpdateConversation,
  
  // Message validations
  validateCreateMessage,
  validateUpdateMessage,
  
  // Project validations
  validateCreateProject,
  validateUpdateProject,
  
  // API Key validations
  validateCreateApiKey,
  validateUpdateApiKey,
  
  // AI validations
  validateAiChat,
  
  // Query validations
  validatePagination,
  validateSearch,
  
  // Param validations
  validateId,
  validateUserId,
  validateConversationId,
  validateProjectId,
  
  // File validations
  validateFileContent,
  
  // Analytics validations
  validateAnalyticsEvent,
  
  // Utilities
  createCustomValidator,
  conditionalValidation,
  mockValidationSuccess,
  mockValidationError
};